<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DTQ1250472"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DTQ1250472');
</script>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juan de Fuca</title>
    <!-- Multiple favicon sizes/formats -->
    <link rel="icon" type="image/png" sizes="32x32" href="path/to/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="path/to/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="path/to/apple-touch-icon.png">
    <style>
        body {
            background-color: #001122;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        h1 {
            margin-top: 20px;
        }
        .time-banner {
            background-color: #112233;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 50px;
        }
        .time-item {
            text-align: center;
        }
        .sunrise-sunset-banner {
            padding: 10px;
            font-size: 1.2em;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        .sun-icon, .sunset-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 8px;
        }
        .current-weather-banner {
            background-color: #223344;
            padding: 15px;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .current-weather-banner .status-dot {
            margin-right: 10px;
        }
        .data-card h3 {
            text-align: center;
            margin: 10px 0;
        }
        .iframe-banner {
            text-align: center;
            background-color: #223344;
            padding: 10px;
            font-weight: bold;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        .buoy-image {
            margin: 0;
            max-width: 95%;
            height: auto;
            margin: 0 auto; /* Center the container */
        }
        .image-pair {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .image-box {
            flex: 1;
            background-color: #1a2b3c;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }
        .weather-outlook-header {
            background-color: #334455;
            padding: 10px;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 30px;
        }
        .iframe-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }
        .iframe-container {
            width: 45%;
            text-align: center;
        }
        .tide-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .tide-container {
            width: 45%;
            background-color: #112233;
            padding: 10px;
            border-radius: 5px;
        }
        .tide-table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #112233;
            border-radius: 8px;
        }
        .tide-table th, .tide-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #334455;
        }
        .tide-table th {
            background-color: #354422;
        }
        .tide-table .day {
            font-weight: bold;
        }
        .tide-table .tide-u div, .tide-table .tide-d div {
            margin-top: 5px;
            font-size: 0.9em;
        }
        .tide-table .tide-u i {
            color: #4CAF50;
        }
        .tide-table .tide-d i {
            color: #f44336;
        }
        .tide-table .sun {
            font-size: 0.9em;
        }
        .tide-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .tide-label {
            padding: 2px 12px;
            background-color: #223344;
            border-radius: 4px;
            font-size: 0.9em;
            color: #ffffff;
            margin-bottom: 5px;
        }
        .tide-value {
            font-size: 0.9em;
            white-space: nowrap;
        }
        .tide-time {
            font-weight: bold;
            margin-bottom: 2px;
        }
        .tide-heights {
            display: flex;
            gap: 10px;
            justify-content: center;
            font-size: 0.9em;
        }
        .tide-heights span {
            white-space: nowrap;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            background-color: #00ff00;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                opacity: 1;
            }
        }

        .embed-container {
            position: relative;
            padding-bottom: 75%;  // Changed from 40% to 60%
            height: 0;
            max-width: 100%;
        }
        .embed-container iframe,
        .embed-container object,
        .embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        small {
            position: absolute;
            z-index: 40;
            bottom: 0;
            margin-bottom: -15px;
        }
        .banner-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;  /* Changed from 20px to 8px */
            width: 100%;
        }

        .icon-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .data-card {
            position: relative;
        }
        
        .expand-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: 1px solid #334455;
            color: #FFFFFF;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            padding: 0;
        }
        
        .expand-button:hover {
            background-color: #334455;
        }
    </style>
</head>
<body>



    <!-- Title Section -->
    <header class="header">
        <div class="header-left">
            <img src="https://raw.githubusercontent.com/Dollardium/surfthestrait/refs/heads/main/stslogo.png"
                 alt="Canadian Coast Guard Logo" 
                 class="header-logo">
            <div class="header-title">
                <h1>Surf Check</h1>
                <em>Juan de Fuca, BC</em>
            </div>
        </div>
        <span id="time-victoria" class="time-victoria"></span>
    </header>

    <!-- Sunrise, Sunset, and Moon Phase Banner -->
    <div class="sunrise-sunset-banner">
        <div class="banner-content">
            <div class="banner-item">
                <svg width="45" height="45" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="4" fill="#FFB800"/>
                    <path d="M12 2V6" stroke="#FFB800" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 18V22" stroke="#FFB800" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 12H2" stroke="#FFB800" stroke-width="2" stroke-linecap="round"/>
                    <path d="M22 12H20" stroke="#FFB800" stroke-width="2" stroke-linecap="round"/>
                    <path d="M19.8 4.2L17 7" stroke="#FFB800" stroke-width="2" stroke-linecap="round"/>
                    <path d="M7 17L4.2 19.8" stroke="#FFB800" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span id="sunrise" class="text-medium"></span>
            </div>
            <span class="banner-divider">|</span>
            <div class="banner-item">
                <svg width="45" height="45" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 18V22" stroke="#FF6B00" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 12H2" stroke="#FF6B00" stroke-width="2" stroke-linecap="round"/>
                    <path d="M22 12H20" stroke="#FF6B00" stroke-width="2" stroke-linecap="round"/>
                    <path d="M19.8 19.8L17 17" stroke="#FF6B00" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4.2 19.8L7 17" stroke="#FF6B00" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 12C4 7.58172 7.58172 4 12 4C16.4183 4 20 7.58172 20 12" stroke="#FF6B00" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span id="sunset" class="text-medium"></span>
            </div>
            <span class="banner-divider">|</span>
            <div class="banner-item">
                <svg width="45" height="45" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="#E1E1E1" stroke-width="2"/>
                    <path id="moon-phase" d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" fill="#E1E1E1"/>
                </svg>
                <span id="moon-phase-text" class="text-medium"></span>
            </div>
        </div>
    </div>
     <!-- Sea State Banner -->
     <div class="current-weather-banner">
        <div class="banner-content" style="gap: 1px;">  <!-- Reduced gap from 8px to 4px -->
            <div class="status-dot"></div>
            Sea States
        </div>
        <div class="text-small">
            <span id="weather-timestamp"></span>
        </div>
    </div>
    <!-- Buoy Image and Cards Wrapper -->
    <div style="width: 95%; margin: 0 auto; background-color: #112233; border-radius: 8px; padding: 20px;"> <!-- New wrapper with background -->
        <!-- Image pair: buoy and Carmanah camera -->
        <div class="image-pair">
            <div class="image-box">
                <img src="https://www.ndbc.noaa.gov/buoycam.php?station=46087"
                     alt="Current Buoy Image">
            </div>
            <div class="image-box">
                <img id="carmanah-image" src="" alt="Carmanah Camera Image">
            </div>
        </div>
        <!-- Cards container -->
        <div style="border-radius: 8px;">  <!-- Removed background-color -->
            <div class="card-container">
                <!-- Wave Card -->
                <div class="data-card">
                    <h3>Waves</h3>
                    <div class="card-content">
                        <div>
                            <span class="tide-label">J-Buoy</span>
                            <div class="text-large font-bold" style="display: flex; gap: 10px; justify-content: center;">
                                <div id="wave-height">-- ft</div>
                                <div id="wave-direction">--</div>
                                <div id="wave-period">-- s</div>
                            </div>
                        </div>
                        <div>
                            <span class="tide-label">La Perouse</span>
                            <div class="text-large font-bold" style="display: flex; gap: 10px; justify-content: center;">
                                <div id="lp-wave-height">-- ft</div>
                                <div id="lp-wave-direction">--</div>
                                <div id="lp-wave-period">-- s</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Temperature Card -->
                <div class="data-card">
                    <h3>Temperatures</h3>
                    <div class="card-content">
                        <div>
                            <span class="tide-label">Water</span>
                            <div class="measurement-group">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L7 7.5C5.1 9.4 4 12.1 4 14.5C4 18.6 7.4 22 12 22C16.6 22 20 18.6 20 14.5C20 12.1 18.9 9.4 17 7.5L12 2ZM12 19.5C8.8 19.5 6.5 17.2 6.5 14.5C6.5 12.8 7.3 10.8 8.7 9.4L12 5.8L15.3 9.3C16.7 10.8 17.5 12.8 17.5 14.5C17.5 17.2 15.2 19.5 12 19.5Z" fill="#FFFFFF"/>
                                    <path d="M12 19.5C14.7614 19.5 17 17.2614 17 14.5C17 11.7386 14.7614 9.5 12 9.5C9.23858 9.5 7 11.7386 7 14.5C7 17.2614 9.23858 19.5 12 19.5Z" fill="#FFFFFF"/>
                                </svg>
                                <div id="water-temp" class="text-large font-bold">--°C</div>
                            </div>
                        </div>
                        <div>
                            <span class="tide-label">Air</span>
                            <div class="measurement-group">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14.5 4C14.5 3.17157 13.8284 2.5 13 2.5C12.1716 2.5 11.5 3.17157 11.5 4V13.7578C10.5771 14.2964 10 15.3375 10 16.5C10 18.1569 11.3431 19.5 13 19.5C14.6569 19.5 16 18.1569 16 16.5C16 15.3375 15.4229 14.2964 14.5 13.7578V4Z" stroke="#FFFFFF" stroke-width="2"/>
                                    <path d="M13 22C15.7614 22 18 19.7614 18 17C18 14.2386 15.7614 12 13 12C10.2386 12 8 14.2386 8 17C8 19.7614 10.2386 22 13 22Z" fill="#FFFFFF"/>
                                </svg>
                                <div id="air-temp" class="text-large font-bold">--°C</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Wind Card -->
                <div class="data-card">
                    <h3>Winds</h3>
                    <div class="card-content">
                        <div>
                            <span class="tide-label">Neah Bay</span>
                            <div class="wind-group" style="gap: 4px;">  <!-- Added style with smaller gap -->
                                <svg id="neah-wind-arrow" class="wind-arrow" width="35" height="35" viewBox="0 0 24 24">  <!-- Reduced width/height -->
                                    <path d="M12 2L9 8H15L12 2Z" fill="currentColor"/>
                                    <rect x="11" y="7" width="2" height="15" fill="currentColor"/>
                                </svg>
                                <div>
                                    <span id="wind-direction" class="text-large font-bold">--</span>
                                    <span id="wind-speed" class="text-large font-bold">-- kts</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <span class="tide-label">Sheringham</span>
                            <div class="wind-group" style="gap: 4px;">  <!-- Added style with smaller gap -->
                                <svg id="sheringham-wind-arrow" class="wind-arrow" width="35" height="35" viewBox="0 0 24 24">  <!-- Reduced width/height -->
                                    <path d="M12 2L9 8H15L12 2Z" fill="currentColor"/>
                                    <rect x="11" y="7" width="2" height="15" fill="currentColor"/>
                                </svg>
                                <span id="sheringham-wind" class="text-large font-bold">-- kts</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Tide Card -->
                <div class="data-card">
                    <h3>Tides</h3>
                    <button id="expandTides" class="expand-button">+</button>
                    <div id="tides" class="tide-grid">
                        <div class="tide-group">
                            <span class="tide-label">Low</span>
                            <div id="tide1" class="tide-value">--</div>
                            <div id="tide3" class="tide-value">--</div>
                        </div>
                        <div class="tide-group">
                            <span class="tide-label">High</span>
                            <div id="tide2" class="tide-value">--</div>
                            <div id="tide4" class="tide-value">--</div>
                        </div>
                    </div>
                    <div id="weeklyTides" class="weekly-tides">
                        <table class="tide-table">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Height</th>
                                </tr>
                            </thead>
                            <tbody id="weeklyTidesBody">
                                <!-- Weekly tide data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Currents Card -->
                <div class="data-card">
                    <h3>Currents</h3>
                    <div class="card-content">
                        <div>
                            <span class="tide-label">J-Bouy</span>
                            <div class="text-large font-bold" style="display: flex; gap: 10px; justify-content: center;">
                                <div id="race-current-speed">Coming Soon :)</div>
                                <div id="race-current-direction"></div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="height: 20px;"></div>

    <!-- Conditions Banner -->
    <div class="current-weather-banner">
        <div class="banner-content" style="gap: 1px;">
            <div class="status-dot"></div>
            Road Conditions & Active Warnings
        </div>
        <div class="text-small">
            <span id="road-conditions-timestamp">Loading...</span>
        </div>
    </div>

    <!-- Road Conditions Card -->
    <div style="background-color: #112233; padding: 25px; border-radius: 8px; margin: 20px auto 0; width: 94%;">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
            <!-- Camera Feed -->
            <div style="flex: 1; min-width: 300px; max-width: 50%;">
                <h4 style="margin: 0 0 10px 0; padding: 8px; background-color: #1a2b3c; border-radius: 4px;">
                    <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M23 19C23 19.5523 22.5523 20 22 20H2C1.44772 20 1 19.5523 1 19V8C1 7.44772 1.44772 7 2 7H6L8 5H16L18 7H22C22.5523 7 23 7.44772 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Jordan River
                </h4>
                <div style="background-color: #1a2b3c; padding: 15px; border-radius: 4px; height: 400px;">
                    <img src="https://cache.drivebc.ca/bchighwaycam/pub/cameras/342.jpg" 
                         alt="Highway 14 Camera Feed" 
                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">
                </div>
            </div>

            <!-- Warnings Feed -->
            <div style="flex: 1; min-width: 300px; max-width: 50%;">
                <h4 style="margin: 0 0 10px 0; padding: 8px; background-color: #1a2b3c; border-radius: 4px;">
                    <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Highway 14
                </h4>
                <div id="warnings-container" style="height: 400px; overflow-y: auto; background-color: #1a2b3c; padding: 15px; border-radius: 4px;">
                    Loading warnings...
                </div>
            </div>
        </div>

    <!-- Interactive Map and Alerts Section -->
    <div style="width: 100%; margin: 20px auto;">
        <h4 style="margin: 0 0 10px 0; padding: 12px; background-color: #1a2b3c; border-radius: 4px; font-size: 1.3em;">
            <svg style="width: 24px; height: 24px; margin-right: 10px; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 9V14M12 17V17.01M12 3L2 21H22L12 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Advisories - BC Coast
        </h4>
        <div style="display: flex; gap: 20px;">
            <!-- Left Indicators -->
            <div style="flex: 1; display: grid; grid-template-rows: repeat(2, 1fr); gap: 15px;">
                <!-- Tsunami Warning Indicator -->
                <div id="tsunami-alert" style="padding: 15px; background-color: #1a2b3c; border-radius: 8px;">
                    <!-- Header -->
                    <h4 style="margin: 0 0 20px 0; padding: 12px; background-color: #1a2b3c; border-radius: 4px; font-size: 1.2em; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div class="status-dot"></div>
                        Tsunami Warnings
                    </h4>
                    <!-- Content -->
                    <div id="tsunami-details" style="margin: 20px 0; font-size: 1.1em; padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            No current warnings in Pacific Ocean
                        </div>
                        <!-- Footer -->
                        <div style="font-size: 0.8em; color: #CCCCCC; margin-top: 15px; padding-top: 15px; border-top: 1px solid #334455;">
                            Source: NOAA's Pacific Tsunami Warning Center
                            <br>
                            Last updated: ${new Date().toLocaleString()}
                        </div>
                    </div>
                </div>

                <!-- Recent Earthquakes -->
                <div id="earthquake-alert" style="padding: 15px; background-color: #1a2b3c; border-radius: 8px;">
                    <h4 style="margin: 0 0 20px 0; padding: 12px; background-color: #1a2b3c; border-radius: 4px; font-size: 1.2em; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div class="status-dot"></div>
                        Recent Earthquakes
                    </h4>
                    <div id="earthquake-list" style="max-height: 200px; overflow-y: auto; padding: 8px;">
                        Loading earthquake data...
                    </div>
                    <div style="font-size: 0.7em; color: #888888; margin-top: 15px; border-top: 1px solid #334455; padding-top: 15px;">
                        Source: USGS Earthquake Hazards Program
                        <br>
                        Last updated: <span id="earthquake-timestamp">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Map Column -->
            <div style="flex: 4;">
                <div class="embed-container">
                    <iframe 
                        width="100" 
                        height="100"
                        frameborder="0"
                        scrolling="no"
                        title="STS" 
                        src="https://ccgroc.maps.arcgis.com/apps/Embed/index.html?webmap=5d4645193b434b46aa63343006245fde&extent=-132.3373,47.1175,-120.2239,51.7772&home=true&zoom=true&theme=dark">
                    </iframe>
                </div>
            </div>

            <!-- Right Indicators -->
            <div style="flex: 1; display: grid; grid-template-rows: repeat(2, 1fr); gap: 15px;">
                <!-- Wildfire Alerts -->
                <div id="wildfire-alert" style="padding: 15px; background-color: #1a2b3c; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; padding: 8px; background-color: #1a2b3c; border-radius: 4px; text-align: center; font-size: 1.2em; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div class="status-dot"></div>
                        Active Wildfires
                    </h4>
                    <div id="wildfire-details" style="margin-top: 5px; font-size: 0.9em; padding: 8px;">
                        No active wildfires in the region
                    </div>
                </div>

                <!-- Flood Warnings -->
                <div id="flood-alert" style="padding: 15px; background-color: #1a2b3c; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; padding: 8px; background-color: #1a2b3c; border-radius: 4px; text-align: center; font-size: 1.2em; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div class="status-dot"></div>
                        Flood Warnings
                    </h4>
                    <div id="flood-details" style="margin-top: 5px; font-size: 0.9em; padding: 8px;">
                        Loading flood data...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        async function fetchRoadWarnings() {
            try {
                const corsProxy = 'https://corsproxy.io/?url=';
                const rssUrl = encodeURIComponent('https://www.drivebc.ca/api/events/region/vanisland?format=rss');
                const response = await fetch(corsProxy + rssUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");
                const items = xmlDoc.getElementsByTagName("item");
                
                const warningsContainer = document.getElementById('warnings-container');
                warningsContainer.innerHTML = ''; // Clear loading message
                
                // Update timestamp
                const timestamp = document.getElementById('road-conditions-timestamp');
                timestamp.textContent = new Date().toLocaleString();
                
                let foundWarnings = false;
                
                for (let item of items) {
                    const title = item.getElementsByTagName("title")[0].textContent;
                    const description = item.getElementsByTagName("description")[0].textContent;
                    const pubDate = item.getElementsByTagName("pubDate")[0].textContent;
                    
                    // Only show warnings for Highway 14
                    if (title.includes("Highway 14") || description.includes("Highway 14")) {
                        foundWarnings = true;
                        const warningDiv = document.createElement('div');
                        warningDiv.style.marginBottom = '15px';
                        warningDiv.style.padding = '10px';
                        warningDiv.style.borderLeft = '3px solid #ff6b00';
                        warningDiv.style.backgroundColor = '#223344';
                        
                        warningDiv.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                            <div style="font-size: 0.9em;">${description}</div>
                            <div style="font-size: 0.8em; color: #888; margin-top: 5px;">
                                ${new Date(pubDate).toLocaleString()}
                            </div>
                        `;
                        
                        warningsContainer.appendChild(warningDiv);
                    }
                }
                
                if (!foundWarnings) {
                    warningsContainer.innerHTML = '<div style="text-align: center; color: #888;">No current warnings for Highway 14</div>';
                }
                
            } catch (error) {
                console.error('Error fetching road warnings:', error);
                document.getElementById('warnings-container').innerHTML = 
                    '<div style="color: #ff6b00;">Error loading warnings. Please try again later.</div>';
            }
        }

        // Initial fetch and refresh every 5 minutes
        fetchRoadWarnings();
        setInterval(fetchRoadWarnings, 300000);
    </script>

    <div style="height: 40px;"></div>

   
    <!-- Footer -->
    <footer style="background-color: #333; color: white; padding: 20px 0; text-align: center; margin-top: 40px;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <p style="margin: 5px 0;">© 2024 Surf the Strait</p>
            <p style="margin: 5px 0; font-size: 0.9em;">Data sources: Environment Canada, Windy.com, NOAA, USGS, BC Wildfire Service, DFO, Drive BC</p>
            <p style="margin: 5px 0; font-size: 0.8em;">For recreational use only. Not to be used for navigational purposes.</p>
        </div>
    </footer>

    <!-- JavaScript Section -->
    <script>
        // Time Display for Victoria
        function updateTimes() {
            const options = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false // Set 24h format
            };
            options.timeZone = 'America/Vancouver';
            const timeElement = document.getElementById('time-victoria');
            const currentTime = new Intl.DateTimeFormat('en-CA', options).format(new Date());
            if (timeElement) {
                timeElement.textContent = currentTime;
                console.log('Time updated:', currentTime);
            } else {
                console.error('Time element not found');
            }
        }
        // Call immediately
        updateTimes();
        // Update every second
        setInterval(updateTimes, 1000);

        // Fetch Sunrise and Sunset Times
        async function fetchSunriseSunset() {
            const response = await fetch('https://api.sunrise-sunset.org/json?lat=48.4284&lng=-123.3656&formatted=0');
            const data = await response.json();
            
            const sunrise = new Date(data.results.sunrise).toLocaleTimeString('en-CA', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Vancouver' });
            const sunset = new Date(data.results.sunset).toLocaleTimeString('en-CA', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Vancouver' });

            document.getElementById('sunrise').textContent = sunrise;
            document.getElementById('sunset').textContent = sunset;
        }
        fetchSunriseSunset();

        // Fetch Sheringham Point Wind Data
        async function fetchSheringhamWind() {
            try {
                console.log('Starting fetch...');
                // Try different CORS proxies
                const corsProxies = [
                    'https://api.allorigins.win/raw?url=',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    'https://cors-anywhere.herokuapp.com/'
                ];
                
                const url = 'https://weather.gc.ca/marine/weatherConditions-currentConditions_e.html?mapID=02&siteID=07010&stationID=WSP';
                let response;
                let text;
                
                // Try each proxy until one works
                for (const proxy of corsProxies) {
                    try {
                        console.log(`Trying proxy: ${proxy}`);
                        response = await fetch(proxy + encodeURIComponent(url));
                        if (response.ok) {
                            text = await response.text();
                            console.log('Successfully fetched data');
                            break;
                        }
                    } catch (e) {
                        console.log(`Proxy ${proxy} failed:`, e);
                        continue;
                    }
                }
                
                if (!text) {
                    throw new Error('All proxies failed');
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                
                // Try multiple methods to find the data
                const methods = {
                    xpath: () => {
                        const xpath = "/html/body/main/div[4]/table/tbody/tr[1]/td[1]";
                        const result = document.evaluate(xpath, doc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
                        return result.singleNodeValue?.textContent;
                    },
                    cssSelector: () => {
                        return doc.querySelector('main div:nth-child(4) table tr:first-child td:first-child')?.textContent;
                    },
                    tableSearch: () => {
                        const tables = doc.querySelectorAll('table');
                        console.log('Found tables:', tables.length);
                        return tables[0]?.querySelector('tr:first-child td:first-child')?.textContent;
                    }
                };

                let windData;
                for (const [method, finder] of Object.entries(methods)) {
                    try {
                        windData = finder();
                        if (windData) {
                            console.log(`Found data using ${method}:`, windData);
                            break;
                        }
                    } catch (e) {
                        console.log(`${method} failed:`, e);
                    }
                }

                if (windData) {
                    const sheringhamElement = document.getElementById('sheringham-wind');
                    // Extract direction and speed from windData
                    const direction = windData.match(/[NSEW]+/)[0];  // Extract cardinal direction
                    const windSpeed = windData.match(/\d+/);  // Extract speed
                    sheringhamElement.textContent = windData.trim() + ' kts';
                    // Update Sheringham wind arrow
                    updateWindArrow('sheringham-wind-arrow', direction);
                    // Pass the parsed wind speed to updateWindColor
                    updateWindColor(sheringhamElement, windSpeed ? parseFloat(windSpeed[0]) : null);
                } else {
                    throw new Error('No wind data found using any method');
                }
            } catch (error) {
                console.error('Detailed error:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('sheringham-wind').textContent = 'Data unavailable';
            }
        }
        fetchSheringhamWind();
        setInterval(fetchSheringhamWind, 300000); // Update every 5 minutes

        // Fetch Buoy Data
        async function fetchBuoyData() {
            try {
                console.log('Fetching buoy data...');
                const corsProxy = 'https://corsproxy.io/?url=';
                const buoyUrl = encodeURIComponent('https://www.ndbc.noaa.gov/data/realtime2/46087.txt');
                const response = await fetch(corsProxy + buoyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Received data:', text.substring(0, 200));
                
                const lines = text.split('\n');
                if (lines.length < 3) {
                    throw new Error(`Invalid data format. Got ${lines.length} lines, expected at least 3`);
                }

                // Get headers and latest data
                const headers = lines[0].trim().split(/\s+/);
                const latestData = lines[2].trim().split(/\s+/);
                
                console.log('Headers:', headers);
                console.log('Latest data:', latestData);

                // Create a data object
                const data = {};
                headers.forEach((header, index) => {
                    data[header] = latestData[index];
                });

                console.log('Parsed data:', data);

                // Update timestamp
                const year = parseInt(data['#YY']);
                const month = parseInt(data['MM']) - 1;
                const day = parseInt(data['DD']);
                const hour = parseInt(data['hh']);
                const minute = parseInt(data['mm']);

                // Fix: Don't add 2000 if the year is already four digits
                const fullYear = year > 100 ? year : 2000 + year;
                const date = new Date(Date.UTC(fullYear, month, day, hour, minute));
                const timeString = date.toLocaleString('en-US', { 
                    timeZone: 'America/Los_Angeles',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });

                document.getElementById('weather-timestamp').textContent = timeString;

                // Update all measurements
                // Wave data
                if (data['WVHT'] && data['WVHT'] !== 'MM') {
                    const waveHeightFt = (parseFloat(data['WVHT']) * 3.28084).toFixed(1);
                    document.getElementById('wave-height').textContent = `${waveHeightFt} ft`;
                }

                if (data['MWD'] && data['MWD'] !== 'MM') {
                    document.getElementById('wave-direction').textContent = degreesToCardinal(data['MWD']);
                }

                if (data['DPD'] && data['DPD'] !== 'MM') {
                    document.getElementById('wave-period').textContent = `${data['DPD']} s`;
                }

                // Temperature data
                if (data['WTMP'] && data['WTMP'] !== 'MM') {
                    document.getElementById('water-temp').textContent = `${data['WTMP']}°C`;
                }

                if (data['ATMP'] && data['ATMP'] !== 'MM') {
                    document.getElementById('air-temp').textContent = `${data['ATMP']}°C`;
                }

                // Wind data
                if (data['WSPD'] && data['WSPD'] !== 'MM') {
                    const windSpeedKts = (parseFloat(data['WSPD']) * 1.944).toFixed(1);
                    const windSpeedElement = document.getElementById('wind-speed');
                    windSpeedElement.textContent = `${windSpeedKts} kts`;
                    updateWindColor(windSpeedElement, parseFloat(windSpeedKts));
                }

                if (data['WDIR'] && data['WDIR'] !== 'MM') {
                    const windDirectionElement = document.getElementById('wind-direction');
                    const direction = degreesToCardinal(data['WDIR']);
                    windDirectionElement.textContent = direction;
                    // Update Neah Bay wind arrow
                    updateWindArrow('neah-wind-arrow', direction);
                    // Use the wind speed for coloring if available
                    const windSpeed = data['WSPD'] !== 'MM' ? parseFloat(data['WSPD']) * 1.944 : null;
                    updateWindColor(windDirectionElement, windSpeed);
                }

                // Fetch La Perouse data
                try {
                    const lpBuoyUrl = encodeURIComponent('https://www.ndbc.noaa.gov/data/realtime2/46206.txt');
                    const lpResponse = await fetch(corsProxy + lpBuoyUrl);
                    
                    if (!lpResponse.ok) {
                        throw new Error(`HTTP error! status: ${lpResponse.status}`);
                    }
                    
                    const lpText = await lpResponse.text();
                    const lpLines = lpText.split('\n');
                    
                    if (lpLines.length < 3) {
                        throw new Error('Invalid La Perouse data format');
                    }

                    const lpHeaders = lpLines[0].trim().split(/\s+/);
                    const lpLatestData = lpLines[2].trim().split(/\s+/);
                    
                    const lpData = {};
                    lpHeaders.forEach((header, index) => {
                        lpData[header] = lpLatestData[index];
                    });

                    // Update La Perouse wave data
                    if (lpData['WVHT'] && lpData['WVHT'] !== 'MM') {
                        const waveHeightFt = (parseFloat(lpData['WVHT']) * 3.28084).toFixed(1);
                        document.getElementById('lp-wave-height').textContent = `${waveHeightFt} ft`;
                    }

                    if (lpData['MWD'] && lpData['MWD'] !== 'MM') {
                        document.getElementById('lp-wave-direction').textContent = degreesToCardinal(lpData['MWD']);
                    }

                    if (lpData['DPD'] && lpData['DPD'] !== 'MM') {
                        document.getElementById('lp-wave-period').textContent = `${lpData['DPD']} s`;
                    }

                } catch (error) {
                    console.error("Failed to fetch La Perouse buoy data:", error);
                    ['lp-wave-height', 'lp-wave-direction', 'lp-wave-period'].forEach(id => {
                        document.getElementById(id).textContent = '--';
                    });
                }

            } catch (error) {
                console.error("Failed to fetch buoy data:", error);
                console.error("Error stack:", error.stack);
                document.getElementById('weather-timestamp').textContent = 'Error loading data';
                
                // Set default values for all fields
                const defaultFields = ['wave-height', 'wave-direction', 'wave-period', 
                                     'water-temp', 'air-temp', 'wind-speed', 'wind-direction'];
                defaultFields.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = '--';
                    }
                });
            }
        }
        fetchBuoyData();
        // Refresh buoy data every 5 minutes
        setInterval(fetchBuoyData, 300000);

        function updateWindColor(element, speed) {
            if (speed === '--' || isNaN(speed)) {
                element.style.color = '#FFFFFF'; // Default white for no data
            } else if (speed <= 5) {
                element.style.color = '#00ff00'; // Green
            } else if (speed <= 10) {
                element.style.color = '#ffff00'; // Yellow
            } else {
                element.style.color = '#ff0000'; // Red
            }
        }

        // Function to convert meters to feet
        function metersToFeet(meters) {
            return meters * 3.28084;
        }

        // Fetch tide data from a live API
        const TIDE_API_KEY = 'YOUR_API_KEY_HERE'; // Register at worldtides.info for a free key

        async function loadTideData() {
            try {
                const lat = 48.55;  // Port Renfrew latitude
                const lon = -124.42; // Port Renfrew longitude
                const url = `https://www.worldtides.info/api/v3?extremes&lat=${lat}&lon=${lon}&days=7&datum=CD&units=feet&key=${TIDE_API_KEY}`;

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const tides = (data.extremes || []).map(e => ({
                    dateTime: new Date(e.date),
                    height: parseFloat(e.height)
                }));

                return tides;
            } catch (error) {
                console.error('Error loading tide data:', error);
                return [];
            }
        }

        // Function to update tide display on the card
        async function updateTides() {
            try {
                const tides = await loadTideData();
                
                // Get current date and time in Pacific Time
                const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/Vancouver"}));
                
                // Filter tides for current time and future only
                const todaysTides = tides.filter(tide => {
                    return tide.dateTime > now;
                }).slice(0, 4); // Get next 4 tides
                
                // Update the first 4 tide values
                for (let i = 0; i < 4; i++) {
                    const tideElement = document.getElementById(`tide${i + 1}`);
                    if (tideElement && todaysTides[i]) {
                        const time = todaysTides[i].dateTime.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false,
                            timeZone: 'America/Vancouver'
                        });
                        const heightFt = todaysTides[i].height;
                        const heightM = (heightFt * 0.3048).toFixed(1);
                        
                        // Determine if it's high or low tide
                        const isHigh = i > 0 && i < todaysTides.length - 1 
                            ? todaysTides[i].height > todaysTides[i - 1].height && 
                              todaysTides[i].height > todaysTides[i + 1].height
                            : todaysTides[i].height > 6.0;
                        
                        tideElement.innerHTML = `
                            <div style="font-size: 0.7em;">${time}</div>
                            <div>
                                <span style="color: ${isHigh ? '#4CAF50' : '#f44336'}">${isHigh ? '▲' : '▼'}</span>
                                ${heightM}m / ${heightFt.toFixed(1)}ft
                            </div>
                        `;
                    } else if (tideElement) {
                        tideElement.innerHTML = '--';
                    }
                }
            } catch (error) {
                console.error('Error updating tides:', error);
            }
        }

        // Function to populate weekly tides
        async function populateWeeklyTides() {
            try {
                const tides = await loadTideData();
                const tbody = document.getElementById('weeklyTidesBody');
                tbody.innerHTML = '';
                
                // Get current date and time
                const now = new Date();
                console.log('Current time for weekly tides:', now); // Debug log
                
                // Get date 7 days from now
                const oneWeekFromNow = new Date(now);
                oneWeekFromNow.setDate(now.getDate() + 7);
                
                // Filter tides starting from current time for next 7 days
                const weekTides = tides.filter(tide => {
                    return tide.dateTime >= now && tide.dateTime < oneWeekFromNow;
                });
                
                console.log('Filtered week tides:', weekTides.slice(0, 5)); // Debug log
                
                // Group tides by date
                const tidesByDate = weekTides.reduce((acc, tide) => {
                    const date = tide.dateTime.toISOString().split('T')[0];
                    if (!acc[date]) {
                        acc[date] = [];
                    }
                    acc[date].push(tide);
                    return acc;
                }, {});
                
                // Create rows for each tide
                Object.entries(tidesByDate).forEach(([date, dayTides]) => {
                    const tideDate = new Date(date);
                    const formattedDate = tideDate.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        timeZone: 'America/Vancouver'
                    });
                    
                    // Add a visual indicator if it's today
                    const isToday = tideDate.toDateString() === now.toDateString();
                    
                    dayTides.forEach((tide, index) => {
                        const tr = document.createElement('tr');
                        const heightFt = tide.height;
                        const heightM = (heightFt * 0.3048).toFixed(1);
                        const time = tide.dateTime.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false,
                            timeZone: 'America/Vancouver'
                        });
                        
                        // Determine if it's high or low tide
                        const isHigh = index > 0 && index < dayTides.length - 1 
                            ? dayTides[index].height > dayTides[index - 1].height && 
                              dayTides[index].height > dayTides[index + 1].height
                            : dayTides[index].height > 6.0;
                        
                        tr.innerHTML = `
                            <td style="padding: 8px; border-bottom: 1px solid #334455; ${isToday ? 'font-weight: bold;' : ''}">${formattedDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #334455;">${time}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #334455; color: white;">
                                <span style="color: ${isHigh ? '#4CAF50' : '#f44336'}">${isHigh ? '▲' : '▼'}</span>
                                ${heightM}m / ${heightFt.toFixed(1)}ft
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
            } catch (error) {
                console.error('Error populating weekly tides:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; color: #ff6b00; padding: 20px;">
                            Error loading tide data
                        </td>
                    </tr>
                `;
            }
        }

        // Initialize tide data
        document.addEventListener('DOMContentLoaded', () => {
            updateTides();
            // Update tides every hour
            setInterval(updateTides, 3600000);
        });

        // Make sure the expand button listener is set up
        document.getElementById('expandTides').addEventListener('click', function() {
            const weeklyTides = document.getElementById('weeklyTides');
            const expandButton = this;
            
            if (weeklyTides.style.display === 'none') {
                weeklyTides.style.display = 'block';
                expandButton.textContent = '−';
                populateWeeklyTides();
            } else {
                weeklyTides.style.display = 'none';
                expandButton.textContent = '+';
            }
        });

        // Make sure this helper function exists
        function degreesToCardinal(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                               'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(((parseFloat(degrees) + 11.25) % 360) / 22.5);
            return directions[index % 16];
        }

        // Moon Phase Calculation
        async function updateMoonPhase() {
            try {
                // Using the same API as sunrise/sunset for consistency
                const response = await fetch('https://api.sunrise-sunset.org/json?lat=48.4284&lng=-123.3656&formatted=0');
                const data = await response.json();
                
                // Calculate moon phase (0-1)
                const date = new Date();
                const synmonth = 29.53058867; // Synodic month length
                const reference = new Date("2000-01-06 00:00:00"); // Known new moon date
                const phase = ((date - reference) / (1000 * 60 * 60 * 24)) % synmonth / synmonth;
                
                // Update moon phase text
                const moonPhaseText = document.getElementById('moon-phase-text');
                const moonPhasePath = document.getElementById('moon-phase');
                
                // Determine phase name and update SVG
                let phaseName;
                if (phase < 0.0625 || phase >= 0.9375) {
                    phaseName = 'New Moon';
                    // Update SVG for new moon
                    moonPhasePath.setAttribute('d', 'M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z');
                    moonPhasePath.setAttribute('fill', '#001122');
                } else if (phase < 0.1875) {
                    phaseName = 'Waxing Crescent';
                    // Add appropriate SVG path for waxing crescent
                } else if (phase < 0.3125) {
                    phaseName = 'First Quarter';
                    // Add appropriate SVG path for first quarter
                } else if (phase < 0.4375) {
                    phaseName = 'Waxing Gibbous';
                    // Add appropriate SVG path for waxing gibbous
                } else if (phase < 0.5625) {
                    phaseName = 'Full Moon';
                    moonPhasePath.setAttribute('fill', '#E1E1E1');
                } else if (phase < 0.6875) {
                    phaseName = 'Waning Gibbous';
                    // Add appropriate SVG path for waning gibbous
                } else if (phase < 0.8125) {
                    phaseName = 'Last Quarter';
                    // Add appropriate SVG path for last quarter
                } else {
                    phaseName = 'Waning Crescent';
                    // Add appropriate SVG path for waning crescent
                }
                
                moonPhaseText.textContent = phaseName;
                
            } catch (error) {
                console.error('Error updating moon phase:', error);
                document.getElementById('moon-phase-text').textContent = 'unavailable';
            }
        }

        // Call immediately and set interval
        updateMoonPhase();
        setInterval(updateMoonPhase, 3600000); // Update every hour

        // Helper function to convert cardinal direction to degrees
        function cardinalToDegrees(cardinal) {
            const directions = {
                'N': 0, 'NNE': 22.5, 'NE': 45, 'ENE': 67.5,
                'E': 90, 'ESE': 112.5, 'SE': 135, 'SSE': 157.5,
                'S': 180, 'SSW': 202.5, 'SW': 225, 'WSW': 247.5,
                'W': 270, 'WNW': 292.5, 'NW': 315, 'NNW': 337.5
            };
            return directions[cardinal] || 0;
        }

        // Function to update wind arrow rotation
        function updateWindArrow(arrowId, direction) {
            const arrow = document.getElementById(arrowId);
            if (arrow && direction) {
                // Add 180 because the arrow should point FROM where the wind is coming
                const degrees = (cardinalToDegrees(direction) + 180) % 360;
                arrow.style.transform = `rotate(${degrees}deg)`;
            }
        }

        // USGS Earthquakes API for Pacific Northwest
        const earthquakeURL = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson';

        async function getRecentEarthquakes() {
            try {
                // USGS API for the last 7 days, all magnitudes
                const corsProxy = 'https://corsproxy.io/?url=';
                const earthquakeURL = encodeURIComponent(
                    'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson'
                );
                
                const response = await fetch(corsProxy + earthquakeURL);
                const data = await response.json();
                
                // Filter for:
                // 1. BC/Washington area (roughly 45°N to 55°N, -130°W to -115°W)
                // 2. OR significant earthquakes (M4.5+) from a broader region that could impact BC
                return data.features.filter(quake => {
                    const [lon, lat] = quake.geometry.coordinates;
                    const magnitude = quake.properties.mag;
                    
                    // Local earthquakes (any magnitude)
                    const isLocalQuake = (
                        lat >= 45 && lat <= 55 && // BC/WA latitude range
                        lon >= -130 && lon <= -115 && // BC/WA longitude range
                        magnitude >= 2.0 // Filter out very small quakes
                    );
                    
                    // Significant regional earthquakes that could impact BC
                    const isSignificantRegional = (
                        lat >= 40 && lat <= 60 && // Broader latitude range
                        lon >= -140 && lon <= -110 && // Broader longitude range
                        magnitude >= 4.5 // Significant magnitude
                    );
                    
                    return isLocalQuake || isSignificantRegional;
                })
                .sort((a, b) => b.properties.time - a.properties.time) // Sort by most recent
                .slice(0, 5); // Show only the 5 most recent relevant quakes
                
            } catch (error) {
                console.error('Error fetching earthquake data:', error);
                return [];
            }
        }

        async function checkTsunamiWarnings() {
            try {
                const corsProxy = 'https://corsproxy.io/?url=';
                // Using NOAA's Pacific Tsunami Warning Center feed
                const tsunamiURL = encodeURIComponent('https://www.tsunami.gov/events/xml/PAAQAtom.xml');
                const response = await fetch(corsProxy + tsunamiURL);
                const text = await response.text();
                
                // Parse XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');
                const entries = xmlDoc.getElementsByTagName('entry');
                
                // Get recent tsunami events
                const tsunamiEvents = Array.from(entries).map(entry => ({
                    title: entry.getElementsByTagName('title')[0]?.textContent,
                    updated: entry.getElementsByTagName('updated')[0]?.textContent,
                    summary: entry.getElementsByTagName('summary')[0]?.textContent,
                    link: entry.getElementsByTagName('link')[0]?.getAttribute('href')
                })).filter(event => 
                    // Filter for actual tsunami events/warnings
                    event.title?.toLowerCase().includes('tsunami') &&
                    // Only include events from the last 24 hours
                    new Date(event.updated) > new Date(Date.now() - 24 * 60 * 60 * 1000)
                );

                return {
                    hasWarning: tsunamiEvents.length > 0,
                    details: tsunamiEvents
                };
            } catch (error) {
                console.error('Error fetching tsunami data:', error);
                return { hasWarning: false, details: [] };
            }
        }

        // Update the display function
        function updateTsunamiDisplay(tsunamiStatus) {
            const tsunamiDetails = document.getElementById('tsunami-details');
            const tsunamiDot = document.querySelector('#tsunami-alert .status-dot');
            
            if (tsunamiStatus.hasWarning) {
                tsunamiDetails.innerHTML = `
                    <div style="margin-bottom: 80px;">
                        ${tsunamiStatus.details.map(event => `
                            <div style="margin-bottom: 15px;">
                                <div style="color: #ff4444; font-weight: bold; margin-bottom: 5px;">
                                    ${event.title}
                                </div>
                                <div style="font-size: 0.8em; margin-bottom: 3px;">
                                    ${new Date(event.updated).toLocaleString()}
                                </div>
                                <div style="font-size: 0.9em;">
                                    ${event.summary}
                                </div>
                                ${event.link ? `<a href="${event.link}" target="_blank" style="color: #4CAF50; font-size: 0.8em;">More details</a>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div style="font-size: 0.7em; color: #888888; margin-top: 80px; border-top: 1px solid #334455; padding-top: 15px;">
                        Source: NOAA's Pacific Tsunami Warning Center
                        <br>
                        Last updated: ${new Date().toLocaleString()}
                    </div>
                `;
                tsunamiDot.style.backgroundColor = '#ff0000';
                tsunamiDetails.style.color = '#ff0000';
            } else {
                tsunamiDetails.innerHTML = `
                    <div style="margin-bottom: 80px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            No Warnings, Advisory, Watch, or Threat in the Pacific Ocean
                        </div>
                    </div>
                    <div style="font-size: 0.7em; color: #888888; margin-top: 120px; border-top: 1px solid #334455; padding-top: 15px;">
                        Source: NOAA's Pacific Tsunami Warning Center
                        <br>
                        Last updated: ${new Date().toLocaleString()}
                    </div>
                `;
                tsunamiDot.style.backgroundColor = '#00ff00';
                tsunamiDetails.style.color = '#00ff00';
            }
        }

        // Update the alerts function
        async function updateAlerts() {
            // Check for tsunami warnings
            const tsunamiStatus = await checkTsunamiWarnings();
            updateTsunamiDisplay(tsunamiStatus);
            
            // Update earthquake list
            const earthquakeList = document.getElementById('earthquake-list');
            const earthquakes = await getRecentEarthquakes();
            
            if (earthquakes && earthquakes.length > 0) {
                earthquakeList.innerHTML = earthquakes.map(quake => {
                    const magnitude = quake.properties.mag;
                    const magnitudeColor = magnitude >= 4.5 ? '#ff4444' : 
                                         magnitude >= 3.0 ? '#ffaa44' : '#88aa88';
                    
                    return `
                        <div style="margin-bottom: 10px; padding: 8px; border-bottom: 1px solid #334455; background-color: #1a2b3c;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: ${magnitudeColor}; font-weight: bold;">M${magnitude.toFixed(1)}</span>
                                <span style="font-size: 0.8em; color: #888;">
                                    ${new Date(quake.properties.time).toLocaleString()}
                                </span>
                            </div>
                            <div style="font-size: 0.9em; margin-top: 4px;">
                                ${quake.properties.place}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                earthquakeList.innerHTML = 'No significant earthquakes in the region';
            }

            // Update the timestamp
            document.getElementById('earthquake-timestamp').textContent = new Date().toLocaleString('en-US', {
                timeZone: 'America/Vancouver',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }

        // Initial update
        updateAlerts();

        // Update every 5 minutes
        setInterval(updateAlerts, 300000);

        // Add some CSS for better visibility
        const style = document.createElement('style');
        style.textContent = `
            .status-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: #00ff00;
            }
            
            #earthquake-list {
                max-height: 300px;
                overflow-y: auto;
                padding-right: 5px;
            }
            
            #earthquake-list::-webkit-scrollbar {
                width: 6px;
            }
            
            #earthquake-list::-webkit-scrollbar-track {
                background: #1a2b3c;
            }
            
            #earthquake-list::-webkit-scrollbar-thumb {
                background: #334455;
                border-radius: 3px;
            }
        `;
        document.head.appendChild(style);

        async function updateWildfireData() {
            try {
                const corsProxy = 'https://corsproxy.io/?url=';
                const apiUrl = encodeURIComponent('https://services6.arcgis.com/ubm4tcTYICKBpist/arcgis/rest/services/BCWS_ActiveFires_PublicView/FeatureServer/0/query?where=FIRE_STATUS%3D%27Active%27&outFields=FIRE_NUMBER,GEOGRAPHIC_DESCRIPTION,FIRE_STATUS,FIRE_CAUSE,RESPONSE_TYPE,IGNITION_DATE,FIRE_SIZE&returnGeometry=true&f=json');
                
                const response = await fetch(corsProxy + apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const wildfireDetails = document.getElementById('wildfire-details');
                const statusDot = document.querySelector('#wildfire-alert .status-dot');

                // Define Southern Vancouver Island boundaries
                const southernVIBounds = {
                    north: 49.5,
                    south: 48.3,
                    east: -123.3,
                    west: -125.0
                };

                // Filter for Southern Vancouver Island fires
                const southernVIFires = data.features?.filter(fire => {
                    if (!fire.geometry || !fire.geometry.coordinates) return false;
                    const coords = fire.geometry.coordinates;
                    return coords[1] >= southernVIBounds.south && 
                           coords[1] <= southernVIBounds.north && 
                           coords[0] >= southernVIBounds.west && 
                           coords[0] <= southernVIBounds.east;
                }) || [];

                // Get current time for the footer
                const currentTime = new Date().toLocaleString('en-US', {
                    timeZone: 'America/Vancouver',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });

                // Create the HTML content
                let contentHtml = `
                   
                    
                    <!-- Content -->
                    <div style="margin: 20px 0; font-size: 1.1em; padding: 15px;">
                        ${southernVIFires.length > 0 
                            ? southernVIFires.map(fire => `
                                <div style="margin-bottom: 10px; padding: 8px; border-bottom: 1px solid #334455;">
                                    <div style="font-weight: bold;">${fire.attributes.GEOGRAPHIC_DESCRIPTION}</div>
                                    <div style="font-size: 0.8em;">
                                        Size: ${fire.attributes.FIRE_SIZE.toFixed(1)} hectares<br>
                                        Cause: ${fire.attributes.FIRE_CAUSE}<br>
                                        Status: ${fire.attributes.FIRE_STATUS}
                                    </div>
                                </div>
                            `).join('')
                            : `<div style="display: flex; align-items: center; gap: 12px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 6L9 17L4 12" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span style="color: #00ff00;">No active wildfires on Southern Vancouver Island</span>
                            </div>`
                        }
                    </div>

                    <!-- Footer -->
                    <div style="font-size: 0.8em; color: #888888; margin-top: 15px; padding-top: 15px; border-top: 1px solid #334455;">
                        Source: BC Wildfire Service
                        <br>
                        Last updated: ${currentTime}
                    </div>`;

                wildfireDetails.innerHTML = contentHtml;
                statusDot.style.backgroundColor = southernVIFires.length > 0 ? '#ff0000' : '#00ff00';

            } catch (error) {
                console.error('Detailed error:', error);
                document.getElementById('wildfire-details').innerHTML = `
                    <div style="color: #ff6b00;">
                        Error loading wildfire data: ${error.message}<br>
                        Please try again later.
                    </div>`;
            }
        }

        // Update initially and every 5 minutes
        updateWildfireData();
        setInterval(updateWildfireData, 300000);

        // Add this new function to fetch flood warnings
        async function updateFloodWarnings() {
            try {
                const corsProxy = 'https://corsproxy.io/?url=';
                const floodURL = encodeURIComponent('https://www.env.gov.bc.ca/wsd/public_safety/flood/warning.xml');
                const response = await fetch(corsProxy + floodURL);
                const text = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');
                const warnings = xmlDoc.getElementsByTagName('warning');
                
                const floodDetails = document.getElementById('flood-details');
                const statusDot = document.querySelector('#flood-alert .status-dot');
                
                // Get current time for the timestamp
                const currentTime = new Date().toLocaleString('en-US', {
                    timeZone: 'America/Vancouver',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });

                if (warnings.length > 0) {
                    // Filter for Vancouver Island warnings
                    const islandWarnings = Array.from(warnings).filter(warning => {
                        const region = warning.getElementsByTagName('region')[0]?.textContent;
                        return region && region.toLowerCase().includes('vancouver island');
                    });

                    if (islandWarnings.length > 0) {
                        floodDetails.innerHTML = `
                            <div style="margin: 20px 0;">
                                ${islandWarnings.map(warning => `
                                    <div style="margin-bottom: 10px; padding: 8px; border-bottom: 1px solid #334455;">
                                        <div style="font-weight: bold;">${warning.getElementsByTagName('region')[0]?.textContent}</div>
                                        <div style="font-size: 0.9em; margin-top: 5px;">
                                            ${warning.getElementsByTagName('description')[0]?.textContent}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        statusDot.style.backgroundColor = '#ff0000';
                    } else {
                        floodDetails.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin: 20px 0;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 6L9 17L4 12" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span style="color: #00ff00;">No flood warnings for Vancouver Island</span>
                            </div>
                        `;
                        statusDot.style.backgroundColor = '#00ff00';
                    }
                } else {
                    floodDetails.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin: 20px 0;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 6L9 17L4 12" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span style="color: #00ff00;">No active flood warnings in BC</span>
                        </div>
                    `;
                    statusDot.style.backgroundColor = '#00ff00';
                }

                // Update timestamp
                document.getElementById('flood-timestamp').textContent = currentTime;

            } catch (error) {
                console.error('Error fetching flood warnings:', error);
                document.getElementById('flood-details').innerHTML = `
                    <div style="color: #ff6b00; text-align: center;">
                        Error loading flood warnings. Please try again later.
                    </div>
                `;
                document.getElementById('flood-timestamp').textContent = 'Error loading data';
            }
        }

        // Initial update
        updateFloodWarnings();

        // Update every 5 minutes
        setInterval(updateFloodWarnings, 300000);

        // Fetch latest Carmanah camera image
        async function fetchCarmanahImage() {
            try {
                const corsProxy = 'https://corsproxy.io/?url=';
                const camUrl = encodeURIComponent('https://ccgsitecams.ca/sites/carmanah/camera_1/');
                const resp = await fetch(corsProxy + camUrl);
                const text = await resp.text();
                const matches = [...text.matchAll(/Carmanah_1_\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2}\.jpg/g)];
                if (matches.length) {
                    const filenames = matches.map(m => m[0]).sort();
                    const latest = filenames[filenames.length - 1];
                    document.getElementById('carmanah-image').src =
                        'https://ccgsitecams.ca/sites/carmanah/camera_1/' + latest;
                }
            } catch (err) {
                console.error('Failed to fetch Carmanah image:', err);
            }
        }
        fetchCarmanahImage();
        setInterval(fetchCarmanahImage, 300000);
    </script>
</body>
</html>
